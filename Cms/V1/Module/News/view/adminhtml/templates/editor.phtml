<?php
/** @var \Magento\Backend\Block\Template $block */
?>

<!-- TinyMCE core -->
<script type="text/javascript" src="<?= $block->getViewFileUrl('Core_News::js/tinymce/tinymce.min.js') ?>"></script>

<script type="text/javascript">
    require(['jquery', 'uiRegistry', 'domReady!'], function($, registry) {

        console.log('üöÄ TinyMCE Management Starting...');

        function initTinyMCE() {
            if (typeof tinymce === 'undefined') {
                console.error('‚ùå TinyMCE not loaded.');
                return;
            }

            var selector = 'textarea[name="news[content]"]';
            var $textarea = $(selector);

            if ($textarea.length) {
                console.log('‚úÖ Found textarea for TinyMCE:', selector);

                tinymce.remove(selector);

                tinymce.init({
                    selector: selector,
                    height: 300,
                    menubar: false,
                    promotion: false,
                    branding: false,
                    plugins: 'lists link image media table code help wordcount',
                    toolbar: 'undo redo | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help',
                    skin_url: '<?= $block->getViewFileUrl('Core_News::js/tinymce/skins/ui/oxide') ?>',
                    content_css: '<?= $block->getViewFileUrl('Core_News::js/tinymce/skins/content/default/content.min.css') ?>',
                    setup: function (editor) {
                        editor.on('change', function () {
                            console.log('‚úçÔ∏è TinyMCE content changed');
                            editor.save(); // Save into the textarea
                            updateMagentoField(); // Update KO binding
                        });
                    }
                });

            } else {
                console.warn('‚åõ Waiting for textarea...');
                setTimeout(initTinyMCE, 500);
            }
        }

        function updateMagentoField() {
            console.log('üîé Trying to update KO ViewModel for content field...');

            var field = registry.get('Core_news_form.Core_news_form.general.content');

            if (field) {
                console.log('‚úÖ KO field found, setting value.');
                field.value($('textarea[name="news[content]"]').val());
            } else {
                console.error('‚ùå KO field NOT FOUND: Core_news_form.Core_news_form.general.content');
            }
        }

        $(document).on('click', '#save', function() {
            console.log('üñ±Ô∏è Save button clicked ‚Äì forcing TinyMCE save');
            if (typeof tinyMCE !== 'undefined' && tinyMCE.activeEditor) {
                tinyMCE.triggerSave();
                updateMagentoField();
            }
        });

        $(document).on('contentUpdated', function() {
            console.log('üîÑ Magento contentUpdated triggered');
            setTimeout(initTinyMCE, 500);
        });

        setTimeout(initTinyMCE, 500);

    });
</script>
